{% load static %}

<div id="chat-window" class="chat-window">
    <div class="chat-header">
        <h5>Chat <span id="chat-status" class="badge bg-success">Online</span></h5>
        <div class="chat-controls">
            <button id="minimize-chat" class="btn btn-sm btn-light"><i class="fas fa-minus"></i></button>
        </div>
    </div>
    
    <div class="chat-body">
        <div class="chat-user-list">
            <div class="input-group mb-2">
                <input type="text" id="user-search" class="form-control form-control-sm" placeholder="Search users...">
            </div>
            <ul id="user-list" class="list-group">
                {% for user in users %}
                <li class="list-group-item user-item" data-user-id="{{ user.id }}">
                    <div class="user-item-content">
                        {{ user.username }}
                        <span class="unread-badge badge bg-danger d-none">New</span>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="chat-messages-container">
            <div id="chat-messages" class="chat-messages">
                <!-- Messages will be loaded here -->
                <div class="no-messages-selected">
                    <p>Select a user to start chatting</p>
                </div>
            </div>
            
            <div class="chat-input">
                <div class="input-group">
                    <input type="text" id="message-input" class="form-control" placeholder="Type a message..." disabled>
                    <button id="emoji-button" class="btn btn-light" type="button" disabled>
                        <i class="fas fa-smile"></i>
                    </button>
                    <button id="send-message" class="btn btn-primary" disabled>Send</button>
                </div>
                <div id="emoji-picker-container" class="emoji-picker-container">
                    <div class="emoji-categories">
                        <button class="emoji-category active" data-category="smileys">ğŸ˜Š</button>
                        <button class="emoji-category" data-category="people">ğŸ‘‹</button>
                        <button class="emoji-category" data-category="animals">ğŸ¶</button>
                        <button class="emoji-category" data-category="food">ğŸ</button>
                        <button class="emoji-category" data-category="travel">ğŸš—</button>
                        <button class="emoji-category" data-category="activities">âš½</button>
                        <button class="emoji-category" data-category="objects">ğŸ’¡</button>
                        <button class="emoji-category" data-category="symbols">â¤ï¸</button>
                    </div>
                    <div class="emoji-container">
                        <div class="emoji-group" id="smileys">
                            <span class="emoji">ğŸ˜€</span><span class="emoji">ğŸ˜ƒ</span><span class="emoji">ğŸ˜„</span><span class="emoji">ğŸ˜</span>
                            <span class="emoji">ğŸ˜†</span><span class="emoji">ğŸ˜…</span><span class="emoji">ğŸ¤£</span><span class="emoji">ğŸ˜‚</span>
                            <span class="emoji">ğŸ™‚</span><span class="emoji">ğŸ™ƒ</span><span class="emoji">ğŸ˜‰</span><span class="emoji">ğŸ˜Š</span>
                            <span class="emoji">ğŸ˜‡</span><span class="emoji">ğŸ¥°</span><span class="emoji">ğŸ˜</span><span class="emoji">ğŸ¤©</span>
                            <span class="emoji">ğŸ˜˜</span><span class="emoji">ğŸ˜—</span><span class="emoji">ğŸ˜š</span><span class="emoji">ğŸ˜™</span>
                            <span class="emoji">ğŸ˜‹</span><span class="emoji">ğŸ˜›</span><span class="emoji">ğŸ˜œ</span><span class="emoji">ğŸ¤ª</span>
                            <span class="emoji">ğŸ˜</span><span class="emoji">ğŸ¤‘</span><span class="emoji">ğŸ¤—</span><span class="emoji">ğŸ¤­</span>
                            <span class="emoji">ğŸ¤«</span><span class="emoji">ğŸ¤”</span><span class="emoji">ğŸ¤</span><span class="emoji">ğŸ¤¨</span>
                        </div>
                        <div class="emoji-group" id="people" style="display:none;">
                            <span class="emoji">ğŸ‘‹</span><span class="emoji">ğŸ¤š</span><span class="emoji">âœ‹</span><span class="emoji">ğŸ–ï¸</span>
                            <span class="emoji">ğŸ‘Œ</span><span class="emoji">ğŸ¤</span><span class="emoji">âœŒï¸</span><span class="emoji">ğŸ¤</span>
                            <span class="emoji">ğŸ¤Ÿ</span><span class="emoji">ğŸ¤˜</span><span class="emoji">ğŸ¤™</span><span class="emoji">ğŸ‘ˆ</span>
                            <span class="emoji">ğŸ‘‰</span><span class="emoji">ğŸ‘†</span><span class="emoji">ğŸ–•</span><span class="emoji">ğŸ‘‡</span>
                            <span class="emoji">ğŸ‘</span><span class="emoji">ğŸ‘</span><span class="emoji">âœŠ</span><span class="emoji">ğŸ‘Š</span>
                            <span class="emoji">ğŸ¤›</span><span class="emoji">ğŸ¤œ</span><span class="emoji">ğŸ‘</span><span class="emoji">ğŸ™Œ</span>
                            <span class="emoji">ğŸ‘</span><span class="emoji">ğŸ¤²</span><span class="emoji">ğŸ™</span><span class="emoji">ğŸ¤</span>
                            <span class="emoji">ğŸ’ª</span><span class="emoji">ğŸ¦¾</span><span class="emoji">ğŸ¦¿</span><span class="emoji">ğŸ¦µ</span>
                        </div>
                        <div class="emoji-group" id="animals" style="display:none;">
                            <span class="emoji">ğŸ¶</span><span class="emoji">ğŸ±</span><span class="emoji">ğŸ­</span><span class="emoji">ğŸ¹</span>
                            <span class="emoji">ğŸ°</span><span class="emoji">ğŸ¦Š</span><span class="emoji">ğŸ»</span><span class="emoji">ğŸ¼</span>
                            <span class="emoji">ğŸ¨</span><span class="emoji">ğŸ¯</span><span class="emoji">ğŸ¦</span><span class="emoji">ğŸ®</span>
                            <span class="emoji">ğŸ·</span><span class="emoji">ğŸ¸</span><span class="emoji">ğŸµ</span><span class="emoji">ğŸ™ˆ</span>
                            <span class="emoji">ğŸ™‰</span><span class="emoji">ğŸ™Š</span><span class="emoji">ğŸ’</span><span class="emoji">ğŸ”</span>
                            <span class="emoji">ğŸ§</span><span class="emoji">ğŸ¦</span><span class="emoji">ğŸ¤</span><span class="emoji">ğŸ£</span>
                            <span class="emoji">ğŸ¦†</span><span class="emoji">ğŸ¦…</span><span class="emoji">ğŸ¦‰</span><span class="emoji">ğŸ¦‡</span>
                            <span class="emoji">ğŸº</span><span class="emoji">ğŸ—</span><span class="emoji">ğŸ´</span><span class="emoji">ğŸ¦„</span>
                        </div>
                        <div class="emoji-group" id="food" style="display:none;">
                            <span class="emoji">ğŸ</span><span class="emoji">ğŸ</span><span class="emoji">ğŸŠ</span><span class="emoji">ğŸ‹</span>
                            <span class="emoji">ğŸŒ</span><span class="emoji">ğŸ‰</span><span class="emoji">ğŸ‡</span><span class="emoji">ğŸ“</span>
                            <span class="emoji">ğŸˆ</span><span class="emoji">ğŸ’</span><span class="emoji">ğŸ‘</span><span class="emoji">ğŸ¥­</span>
                            <span class="emoji">ğŸ</span><span class="emoji">ğŸ¥¥</span><span class="emoji">ğŸ¥</span><span class="emoji">ğŸ…</span>
                            <span class="emoji">ğŸ†</span><span class="emoji">ğŸ¥‘</span><span class="emoji">ğŸ¥¦</span><span class="emoji">ğŸ¥¬</span>
                            <span class="emoji">ğŸŒ­</span><span class="emoji">ğŸ”</span><span class="emoji">ğŸŸ</span><span class="emoji">ğŸ•</span>
                            <span class="emoji">ğŸ¥ª</span><span class="emoji">ğŸ¥™</span><span class="emoji">ğŸ§†</span><span class="emoji">ğŸŒ®</span>
                            <span class="emoji">ğŸŒ¯</span><span class="emoji">ğŸ¥—</span><span class="emoji">ğŸ¥˜</span><span class="emoji">ğŸ¥«</span>
                        </div>
                        <div class="emoji-group" id="travel" style="display:none;">
                            <span class="emoji">ğŸš—</span><span class="emoji">ğŸš•</span><span class="emoji">ğŸš™</span><span class="emoji">ğŸšŒ</span>
                            <span class="emoji">ğŸš</span><span class="emoji">ğŸï¸</span><span class="emoji">ğŸš“</span><span class="emoji">ğŸš‘</span>
                            <span class="emoji">ğŸš’</span><span class="emoji">ğŸš</span><span class="emoji">ğŸšš</span><span class="emoji">ğŸš›</span>
                            <span class="emoji">ğŸšœ</span><span class="emoji">ğŸ›´</span><span class="emoji">ğŸš²</span><span class="emoji">ğŸ›µ</span>
                            <span class="emoji">ğŸï¸</span><span class="emoji">ğŸš¨</span><span class="emoji">ğŸš”</span><span class="emoji">ğŸš</span>
                            <span class="emoji">ğŸš˜</span><span class="emoji">ğŸš–</span><span class="emoji">ğŸš¡</span><span class="emoji">ğŸš </span>
                            <span class="emoji">ğŸšŸ</span><span class="emoji">ğŸšƒ</span><span class="emoji">ğŸš‹</span><span class="emoji">ğŸš</span>
                            <span class="emoji">ğŸš</span><span class="emoji">ğŸš„</span><span class="emoji">ğŸš…</span><span class="emoji">ğŸšˆ</span>
                        </div>
                        <div class="emoji-group" id="activities" style="display:none;">
                            <span class="emoji">âš½</span><span class="emoji">ğŸ€</span><span class="emoji">ğŸˆ</span><span class="emoji">âš¾</span>
                            <span class="emoji">ğŸ¥</span><span class="emoji">ğŸ¾</span><span class="emoji">ğŸ</span><span class="emoji">ğŸ‰</span>
                            <span class="emoji">ğŸ¥</span><span class="emoji">ğŸ±</span><span class="emoji">ğŸª€</span><span class="emoji">ğŸ“</span>
                            <span class="emoji">ğŸ¸</span><span class="emoji">ğŸ’</span><span class="emoji">ğŸ‘</span><span class="emoji">ğŸ¥</span>
                            <span class="emoji">ğŸ</span><span class="emoji">ğŸ¥…</span><span class="emoji">â›³</span><span class="emoji">ğŸª</span>
                            <span class="emoji">ğŸ¯</span><span class="emoji">ğŸ¥Š</span><span class="emoji">ğŸ¥‹</span><span class="emoji">ğŸ½</span>
                            <span class="emoji">ğŸ›¹</span><span class="emoji">ğŸ›·</span><span class="emoji">â›¸ï¸</span><span class="emoji">ğŸ¥Œ</span>
                            <span class="emoji">ğŸ¿</span><span class="emoji">â›·ï¸</span><span class="emoji">ğŸ‚</span><span class="emoji">ğŸª‚</span>
                        </div>
                        <div class="emoji-group" id="objects" style="display:none;">
                            <span class="emoji">âŒš</span><span class="emoji">ğŸ“±</span><span class="emoji">ğŸ“²</span><span class="emoji">ğŸ’»</span>
                            <span class="emoji">âŒ¨ï¸</span><span class="emoji">ğŸ–¥ï¸</span><span class="emoji">ğŸ–¨ï¸</span><span class="emoji">ğŸ–±ï¸</span>
                            <span class="emoji">ğŸ–²ï¸</span><span class="emoji">ğŸ•¹ï¸</span><span class="emoji">ğŸ—œï¸</span><span class="emoji">ğŸ’½</span>
                            <span class="emoji">ğŸ’¾</span><span class="emoji">ğŸ’¿</span><span class="emoji">ğŸ“€</span><span class="emoji">ğŸ“¼</span>
                            <span class="emoji">ğŸ“·</span><span class="emoji">ğŸ“¸</span><span class="emoji">ğŸ“¹</span><span class="emoji">ğŸ¥</span>
                            <span class="emoji">ğŸ“½ï¸</span><span class="emoji">ğŸï¸</span><span class="emoji">ğŸ“</span><span class="emoji">â˜ï¸</span>
                            <span class="emoji">ğŸ“Ÿ</span><span class="emoji">ğŸ“ </span><span class="emoji">ğŸ“º</span><span class="emoji">ğŸ“»</span>
                            <span class="emoji">ğŸ™ï¸</span><span class="emoji">ğŸšï¸</span><span class="emoji">ğŸ›ï¸</span><span class="emoji">ğŸ§­</span>
                        </div>
                        <div class="emoji-group" id="symbols" style="display:none;">
                            <span class="emoji">â¤ï¸</span><span class="emoji">ğŸ§¡</span><span class="emoji">ğŸ’›</span><span class="emoji">ğŸ’š</span>
                            <span class="emoji">ğŸ’™</span><span class="emoji">ğŸ’œ</span><span class="emoji">ğŸ–¤</span><span class="emoji">ğŸ¤</span>
                            <span class="emoji">ğŸ¤</span><span class="emoji">ğŸ’”</span><span class="emoji">â£ï¸</span><span class="emoji">ğŸ’•</span>
                            <span class="emoji">ğŸ’</span><span class="emoji">ğŸ’“</span><span class="emoji">ğŸ’—</span><span class="emoji">ğŸ’–</span>
                            <span class="emoji">ğŸ’˜</span><span class="emoji">ğŸ’</span><span class="emoji">ğŸ’Ÿ</span><span class="emoji">â˜®ï¸</span>
                            <span class="emoji">âœï¸</span><span class="emoji">â˜ªï¸</span><span class="emoji">ğŸ•‰ï¸</span><span class="emoji">â˜¸ï¸</span>
                            <span class="emoji">âœ¡ï¸</span><span class="emoji">ğŸ”¯</span><span class="emoji">ğŸ•</span><span class="emoji">â˜¯ï¸</span>
                            <span class="emoji">â˜¦ï¸</span><span class="emoji">ğŸ›</span><span class="emoji">â›</span><span class="emoji">â™ˆ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // DOM elements
        const chatWindow = document.getElementById('chat-window');
        const minimizeBtn = document.getElementById('minimize-chat');
        const userList = document.getElementById('user-list');
        const userSearch = document.getElementById('user-search');
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-message');
        const emojiButton = document.getElementById('emoji-button');
        const emojiPickerContainer = document.getElementById('emoji-picker-container');
        
        let currentReceiverId = null;
        let minimized = false;
        
        // Initialize
        function init() {
            loadUsers();
            setupEventListeners();
            
            // Check for new messages every 10 seconds
            setInterval(checkNewMessages, 10000);
        }
        
        // Load users
        function loadUsers() {
            fetch('{% url "get_users" %}')
                .then(response => response.json())
                .then(data => {
                    userList.innerHTML = '';
                    data.users.forEach(user => {
                        const li = document.createElement('li');
                        li.className = 'list-group-item user-item';
                        li.setAttribute('data-user-id', user.id);
                        
                        // Create a container for the user item content
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'user-item-content';
                        
                        // Add username
                        const usernameSpan = document.createElement('span');
                        usernameSpan.textContent = user.full_name || user.username;
                        contentDiv.appendChild(usernameSpan);
                        
                        // Add unread badge
                        const badgeSpan = document.createElement('span');
                        badgeSpan.className = `unread-badge badge bg-danger ${!user.unread ? 'd-none' : ''}`;
                        badgeSpan.textContent = 'New';
                        contentDiv.appendChild(badgeSpan);
                        
                        // Add the content to the list item
                        li.appendChild(contentDiv);
                        
                        // Add click event directly to the list item
                        li.addEventListener('click', function() {
                            // Remove active class from all users
                            userList.querySelectorAll('.user-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            
                            // Add active class to this user
                            this.classList.add('active');
                            
                            // Load messages for this user
                            loadMessages(user.id);
                        });
                        
                        userList.appendChild(li);
                    });
                })
                .catch(error => console.error('Error loading users:', error));
        }
        
        // Load messages for a specific user
        function loadMessages(userId) {
            currentReceiverId = userId;
            messageInput.disabled = false;
            sendButton.disabled = false;
            emojiButton.disabled = false;
            
            fetch(`{% url "get_messages_with_user" user_id=0 %}`.replace('0', userId))
                .then(response => response.json())
                .then(data => {
                    chatMessages.innerHTML = '';
                    
                    if (data.messages.length === 0) {
                        chatMessages.innerHTML = '<div class="no-messages"><p>No messages yet. Start a conversation!</p></div>';
                        return;
                    }
                    
                    data.messages.forEach(message => {
                        const isCurrentUser = message.sender_id === parseInt("{{ request.user.id }}");
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `message ${isCurrentUser ? 'message-sent' : 'message-received'}`;
                        messageDiv.innerHTML = `
                            <div class="message-content">
                                <p>${message.message}</p>
                                <small class="message-time">${message.timestamp}</small>
                            </div>
                        `;
                        chatMessages.appendChild(messageDiv);
                    });
                    
                    // Scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    // Remove unread badge
                    const userItem = userList.querySelector(`[data-user-id="${userId}"]`);
                    if (userItem) {
                        const badge = userItem.querySelector('.unread-badge');
                        if (badge) {
                            badge.classList.add('d-none');
                        }
                    }
                })
                .catch(error => console.error('Error loading messages:', error));
        }
        
        // Send a message
        function sendMessage() {
            console.log('Send message function called');
            let message = messageInput.value.trim();
            if (!message || !currentReceiverId) {
                console.log('Message empty or no receiver selected');
                return;
            }
            console.log('Sending message to user ID:', currentReceiverId);
            
            fetch('{% url "send_message" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    receiver_id: currentReceiverId,
                    message: message
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Add message to chat
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message message-sent';
                    messageDiv.innerHTML = `
                        <div class="message-content">
                            <p>${data.message.message}</p>
                            <small class="message-time">${data.message.timestamp}</small>
                        </div>
                    `;
                    chatMessages.appendChild(messageDiv);
                    
                    // Clear input and scroll to bottom
                    messageInput.value = '';
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            })
            .catch(error => console.error('Error sending message:', error));
        }
        
        // Check for new messages
        function checkNewMessages() {
            fetch('{% url "get_users" %}')
                .then(response => response.json())
                .then(data => {
                    data.users.forEach(user => {
                        const userItem = userList.querySelector(`[data-user-id="${user.id}"]`);
                        if (userItem) {
                            const badge = userItem.querySelector('.unread-badge');
                            if (badge) {
                                if (user.unread && user.id !== currentReceiverId) {
                                    badge.classList.remove('d-none');
                                } else {
                                    badge.classList.add('d-none');
                                }
                            }
                        }
                    });
                    
                    // If a conversation is active, refresh messages
                    if (currentReceiverId) {
                        loadMessages(currentReceiverId);
                    }
                })
                .catch(error => console.error('Error checking new messages:', error));
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Hide emoji picker by default
            emojiPickerContainer.style.display = 'none';
            
            // Toggle emoji picker on button click
            emojiButton.addEventListener('click', function(e) {
                e.stopPropagation();
                console.log('Emoji button clicked');
                if (emojiPickerContainer.style.display === 'none') {
                    emojiPickerContainer.style.display = 'block';
                } else {
                    emojiPickerContainer.style.display = 'none';
                }
            });
            
            // Handle emoji category selection
            const emojiCategories = document.querySelectorAll('.emoji-category');
            emojiCategories.forEach(category => {
                category.addEventListener('click', function() {
                    // Remove active class from all categories
                    emojiCategories.forEach(cat => cat.classList.remove('active'));
                    
                    // Add active class to clicked category
                    this.classList.add('active');
                    
                    // Hide all emoji groups
                    document.querySelectorAll('.emoji-group').forEach(group => {
                        group.style.display = 'none';
                    });
                    
                    // Show the selected emoji group
                    const categoryName = this.getAttribute('data-category');
                    document.getElementById(categoryName).style.display = 'block';
                });
            });
            
            // Handle emoji selection
            const emojis = document.querySelectorAll('.emoji');
            emojis.forEach(emoji => {
                emoji.addEventListener('click', function() {
                    console.log('Emoji clicked:', this.textContent);
                    // Insert emoji at cursor position or append to end
                    const cursorPos = messageInput.selectionStart;
                    const textBeforeCursor = messageInput.value.substring(0, cursorPos);
                    const textAfterCursor = messageInput.value.substring(cursorPos);
                    messageInput.value = textBeforeCursor + this.textContent + textAfterCursor;
                    
                    // Move cursor after inserted emoji
                    const newCursorPos = cursorPos + this.textContent.length;
                    messageInput.setSelectionRange(newCursorPos, newCursorPos);
                    
                    // Hide emoji picker and focus on input
                    emojiPickerContainer.style.display = 'none';
                    messageInput.focus();
                });
            });
            
            // Close emoji picker when clicking outside
            document.addEventListener('click', function(e) {
                if (!emojiPickerContainer.contains(e.target) && e.target !== emojiButton) {
                    emojiPickerContainer.style.display = 'none';
                }
            });
            // Minimize/maximize chat window
            minimizeBtn.addEventListener('click', function() {
                minimized = !minimized;
                chatWindow.classList.toggle('minimized', minimized);
                minimizeBtn.innerHTML = minimized ? '<i class="fas fa-expand"></i>' : '<i class="fas fa-minus"></i>';
            });
            
            // User search
            userSearch.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const userItems = userList.querySelectorAll('.user-item');
                
                userItems.forEach(item => {
                    const username = item.textContent.toLowerCase();
                    if (username.includes(searchTerm)) {
                        item.style.display = '';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // User selection
            userList.addEventListener('click', function(e) {
                // Find the closest .user-item element from the click target
                const userItem = e.target.closest('.user-item');
                
                if (userItem) {
                    // Get the user ID from the data attribute
                    const userId = userItem.getAttribute('data-user-id');
                    console.log('User clicked:', userId);
                    
                    // Remove active class from all users
                    userList.querySelectorAll('.user-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Add active class to selected user
                    userItem.classList.add('active');
                    
                    // Load messages for selected user
                    loadMessages(userId);
                }
            });
            
            // Send message on button click
            sendButton.addEventListener('click', sendMessage);
            
            // Send message on Enter key
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Initialize the chat
        init();
    });
</script>
